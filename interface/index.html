<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <link rel="shortcut icon" href="./favicon.png" type="image/png" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg: #ffffff;
        --bg-subtle: #f6f8fa;
        --border: #d0d7de;
        --fg: #1f2328;
        --fg-muted: #656d76;
        --accent: #0969da;
        --success: #1a7f37;
        --danger: #cf222e;
        --attention: #9a6700;
        --radius: 6px;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family:
          "Plus Jakarta Sans",
          -apple-system,
          system-ui,
          sans-serif;
        background-color: var(--bg);
        color: var(--fg);
        margin: 0;
        font-size: 14px;
        line-height: 1.5;
      }

      header {
        border-bottom: 1px solid var(--border);
        background-color: var(--bg-subtle);
        position: sticky;
        top: 0;
        z-index: 50;
      }
      .header-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 12px 16px 0;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }
      .brand h1 {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }

      nav {
        display: flex;
        overflow-x: auto;
        gap: 4px;
        scrollbar-width: none;
      }
      nav::-webkit-scrollbar {
        display: none;
      }
      .nav-link {
        padding: 8px 12px;
        color: var(--fg);
        text-decoration: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
      }
      .nav-link.active {
        border-bottom-color: #fd8c73;
        font-weight: 600;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px 16px;
      }
      .content-section {
        display: none;
      }
      .content-section.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }
      .stat-card {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 12px;
        background: white;
      }
      .stat-val {
        font-size: 18px;
        font-weight: 600;
        color: var(--accent);
        display: block;
      }
      .stat-lbl {
        font-size: 11px;
        color: var(--fg-muted);
        text-transform: uppercase;
        font-weight: 500;
      }

      .Box {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: white;
        margin-bottom: 20px;
        overflow: hidden;
      }
      .Box-header {
        background: var(--bg-subtle);
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .Box-title {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
      }
      .Box-row {
        padding: 16px;
        border-top: 1px solid var(--border);
        transition: background 0.1s;
      }
      .Box-row:first-child {
        border-top: 0;
      }

      .btn {
        padding: 6px 14px;
        font-size: 14px;
        font-weight: 500;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: var(--bg-subtle);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .btn-primary {
        background: #1f883d;
        color: white;
        border-color: rgba(31, 35, 40, 0.15);
      }
      input,
      select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 14px;
        margin: 8px 0 16px;
      }

      .badge {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 500;
        border: 1px solid transparent;
      }
      .badge-success {
        background: #dafbe1;
        color: var(--success);
      }
      .badge-warn {
        background: #fff8c5;
        color: var(--attention);
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(31, 35, 40, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
        padding: 16px;
        backdrop-filter: blur(2px);
      }
      .modal-card {
        background: white;
        width: 100%;
        max-width: 400px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      }

      /* News Specific */
      .news-title {
        font-weight: 600;
        color: var(--accent);
        text-decoration: none;
        display: block;
        margin-bottom: 4px;
      }
      .news-desc {
        font-size: 13px;
        color: var(--fg-muted);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .chart-container {
        height: 200px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-container">
        <div class="brand">
          <svg height="24" viewBox="0 0 16 16" width="24" fill="currentColor">
            <path
              d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"
            ></path>
          </svg>
          <h1>Whatsaly</h1>
        </div>
        <nav>
          <div class="nav-link active" onclick="tab('dashboard', this)">
            Dashboard
          </div>
          <div class="nav-link" onclick="tab('news', this)">Updates</div>
          <div class="nav-link" onclick="tab('pair', this)">Connect</div>
        </nav>
      </div>
    </header>

    <main class="container">
      <section id="dashboard" class="content-section active">
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-lbl">CPU Load</span
            ><span class="stat-val" id="cpu-v">0%</span>
          </div>
          <div class="stat-card">
            <span class="stat-lbl">Memory</span
            ><span class="stat-val" id="mem-v">0%</span>
          </div>
          <div class="stat-card">
            <span class="stat-lbl">Disk</span
            ><span class="stat-val" id="dsk-v">0%</span>
          </div>
        </div>

        <div class="Box">
          <div class="Box-header">
            <h3 class="Box-title">Live Performance</h3>
          </div>
          <div class="chart-container"><canvas id="perfChart"></canvas></div>
        </div>

        <div class="Box">
          <div class="Box-header">
            <h3 class="Box-title">Active Sessions</h3>
            <button
              class="btn"
              onclick="fetchSessions()"
              style="
                padding: 2px 10px;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                background: #fff;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                color: #374151;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                transition: background 0.2s;
              "
              onmouseover="this.style.background = '#f9fafb'"
              onmouseout="this.style.background = '#fff'"
            >
              Refresh
            </button>
          </div>
          <div id="session-list"></div>
        </div>
      </section>

      <section id="news" class="content-section">
        <div class="Box">
          <div class="Box-header">
            <h3 class="Box-title">WhatsApp Beta Feed</h3>
          </div>
          <div id="news-feed"></div>
        </div>
      </section>

      <section id="pair" class="content-section">
        <div class="Box">
          <div class="Box-header">
            <h3 class="Box-title">Add New Instance</h3>
          </div>
          <div class="Box-row" style="text-align: center; padding: 40px 20px">
            <p style="color: var(--fg-muted); margin-bottom: 20px">
              Link a phone number to start automating.
            </p>
            <button class="btn btn-primary" onclick="toggleModal(true)">
              Link with Phone Number
            </button>
          </div>
        </div>
      </section>
    </main>

    <div class="modal-overlay" id="modalOverlay">
      <div class="modal-card">
        <div class="Box-header">
          <span class="Box-title">Pair Device</span>
          <span style="cursor: pointer" onclick="toggleModal(false)"
            >&times;</span
          >
        </div>
        <div class="Box-row" id="setupView">
          <label style="font-size: 12px; font-weight: 600">Country Code</label>
          <select id="country">
            <option value="234">Nigeria (+234)</option>
            <option value="1">USA (+1)</option>
          </select>
          <label style="font-size: 12px; font-weight: 600">Phone Number</label>
          <input type="text" id="phone" placeholder="80609487542" />
          <button
            class="btn btn-primary"
            style="width: 100%; justify-content: center"
            onclick="doPair()"
          >
            Request Code
          </button>
        </div>
        <div
          class="Box-row"
          id="waitView"
          style="display: none; text-align: center; padding: 30px"
        >
          <p>Generating pairing code...</p>
          <div
            id="poll-status"
            style="font-size: 11px; color: var(--fg-muted); margin-top: 10px"
          >
            Waiting for server...
          </div>
        </div>
        <div
          class="Box-row"
          id="resultView"
          style="display: none; text-align: center; padding: 30px"
        >
          <span
            style="
              font-size: 11px;
              color: var(--fg-muted);
              text-transform: uppercase;
            "
            >Your Code</span
          >
          <div
            id="codeBox"
            style="
              font-size: 32px;
              font-weight: 600;
              color: var(--accent);
              letter-spacing: 4px;
              margin: 15px 0;
            "
          >
            ----
          </div>
          <button
            class="btn"
            style="width: 100%; justify-content: center"
            onclick="toggleModal(false)"
          >
            Finish
          </button>
        </div>
      </div>
    </div>

    <script>
      let chart;
      const maxPoints = 20;

      function tab(name, el) {
        document
          .querySelectorAll(".content-section")
          .forEach((s) => s.classList.remove("active"));
        document
          .querySelectorAll(".nav-link")
          .forEach((l) => l.classList.remove("active"));
        document.getElementById(name).classList.add("active");
        el.classList.add("active");
        if (name === "news") fetchNews();
        if (name === "dashboard") fetchSessions();
      }

      function initPerf() {
        const ctx = document.getElementById("perfChart").getContext("2d");
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: Array(maxPoints).fill(""),
            datasets: [
              {
                label: "CPU Usage %",
                data: Array(maxPoints).fill(0),
                borderColor: "#0969da",
                backgroundColor: "rgba(9,105,218,0.1)",
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { min: 0, max: 100, grid: { color: "#f0f0f0" } },
              x: { display: false },
            },
          },
        });

        const stream = new EventSource("/api/system/stream");
        stream.onmessage = (e) => {
          const d = JSON.parse(e.data);
          document.getElementById("cpu-v").innerText = d.cpu.toFixed(1) + "%";
          document.getElementById("mem-v").innerText =
            d.memory.toFixed(0) + "%";
          document.getElementById("dsk-v").innerText = d.disk.toFixed(1) + "%";
          chart.data.datasets[0].data.push(d.cpu);
          chart.data.datasets[0].data.shift();
          chart.update("none");
        };
      }

      async function fetchSessions() {
        const container = document.getElementById("session-list");
        container.innerHTML = '<div class="Box-row">Loading...</div>';
        try {
          const res = await fetch("/api/instances");
          const data = await res.json();
          container.innerHTML = data.length
            ? data
                .map(
                  (s) => `
        <div class="Box-row" style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-weight:600; font-family:monospace;">${s.Name}</div>
            <div style="font-size:11px; color:var(--fg-muted);">Updated: ${new Date(
              s.CreatedAt,
            ).toLocaleTimeString()}</div>
          </div>
          <span class="badge ${
            s.Status === "connected" ? "badge-success" : "badge-warn"
          }">${s.Status}</span>
        </div>
      `,
                )
                .join("")
            : '<div class="Box-row">No sessions.</div>';
        } catch (e) {
          container.innerHTML =
            '<div class="Box-row">Error fetching sessions.</div>';
        }
      }

      async function fetchNews() {
        const container = document.getElementById("news-feed");
        container.innerHTML = '<div class="Box-row">Fetching...</div>';
        try {
          const res = await fetch("/util/whatsapp-news");
          const json = await res.json();
          container.innerHTML = json.data
            .map(
              (n) => `
        <div class="Box-row">
          <a href="${n.link}" target="_blank" class="news-title">${n.title}</a>
          <div class="news-desc">${n.description.trim()}</div>
          <div style="font-size:11px; color:var(--fg-muted); margin-top:8px;">${
            n.date
          }</div>
        </div>
      `,
            )
            .join("");
        } catch (e) {
          container.innerHTML = '<div class="Box-row">News unavailable.</div>';
        }
      }

      function toggleModal(s) {
        document.getElementById("modalOverlay").style.display = s
          ? "flex"
          : "none";
        if (!s) {
          document.getElementById("setupView").style.display = "block";
          document.getElementById("waitView").style.display = "none";
          document.getElementById("resultView").style.display = "none";
        }
      }

      async function doPair() {
        let num = document
          .getElementById("phone")
          .value.trim()
          .replace(/^0/, "");
        const full = document.getElementById("country").value + num;
        document.getElementById("setupView").style.display = "none";
        document.getElementById("waitView").style.display = "block";

        try {
          const res = await fetch(`/api/instances/${full}/pair`, {
            method: "POST",
          });
          if (res.ok) {
            let att = 0;
            const poll = setInterval(async () => {
              att++;
              document.getElementById("poll-status").innerText =
                `Attempting to retrieve code (${att}/15)...`;
              const check = await fetch(`/api/instances/${full}`);
              const d = await check.json();
              if (d.pairing_code) {
                clearInterval(poll);
                document.getElementById("waitView").style.display = "none";
                document.getElementById("resultView").style.display = "block";
                document.getElementById("codeBox").innerText = d.pairing_code;
              }
              if (att >= 15) {
                clearInterval(poll);
                toggleModal(false);
                alert("Timeout");
              }
            }, 2000);
          }
        } catch (e) {
          toggleModal(false);
          alert("Request Failed");
        }
      }

      window.onload = () => {
        initPerf();
        fetchSessions();
      };
    </script>
  </body>
</html>

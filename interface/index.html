<!doctype html>
<html lang="en" class="h-full">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <title>Whatsaly | Pro Panel</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn-uicons.flaticon.com/2.1.0/uicons-regular-rounded/css/uicons-regular-rounded.css"
        />
        <style>
            body {
                font-family: "Inter", sans-serif;
                background-color: #fdfdfd;
                color: #1f2328;
                -webkit-tap-highlight-color: transparent;
            }
            .mono {
                font-family: "Roboto Mono", monospace;
            }
            .content-section {
                display: none;
            }
            .content-section.active {
                display: block;
                animation: fadeIn 0.2s ease-in-out;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(5px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Fixed Header */
            .glass-header {
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid #d0d7de;
            }

            /* Cards */
            .gh-card {
                border: 1px solid #d0d7de;
                border-radius: 12px;
                background: #ffffff;
                overflow: hidden;
            }
            .gh-header {
                background-color: #f6f8fa;
                border-bottom: 1px solid #d0d7de;
                padding: 12px 16px;
            }

            /* Mobile Bottom Nav Fix */
            @media (max-width: 768px) {
                .mobile-bottom-nav {
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-top: 1px solid #d0d7de;
                    z-index: 100;
                    padding-bottom: env(safe-area-inset-bottom);
                    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
                }
                .nav-link {
                    flex-direction: column;
                    gap: 4px;
                    padding: 10px 0;
                    font-size: 10px;
                    width: 33.33%;
                    text-align: center;
                    color: #656d76;
                }
                .nav-link i {
                    font-size: 18px;
                }
                .nav-link.active {
                    color: #0969da;
                }

                /* THIS FIXES THE CLIPPING: Adds enough space for the last element */
                main {
                    padding-bottom: calc(
                        80px + env(safe-area-inset-bottom)
                    ) !important;
                }
            }

            /* Desktop Nav */
            @media (min-width: 769px) {
                .nav-link {
                    position: relative;
                    padding: 20px 12px;
                    color: #656d76;
                    font-size: 14px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                .nav-link.active::after {
                    content: "";
                    position: absolute;
                    bottom: -1px;
                    left: 0;
                    right: 0;
                    height: 2px;
                    background: #fd8c73;
                }
                .nav-link.active {
                    color: #1f2328;
                }
            }

            .status-pulse {
                width: 8px;
                height: 8px;
                border-radius: 50%;
            }
            .pulse-green {
                background: #1f883d;
                box-shadow: 0 0 8px rgba(31, 136, 61, 0.4);
            }
            .pulse-red {
                background: #cf222e;
            }

            .btn-gh {
                border: 1px solid #d0d7de;
                background: #f6f8fa;
                padding: 10px 16px;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: 0.2s;
            }
            .btn-primary {
                background: #1f883d;
                color: #fff;
                border: 1px solid rgba(31, 35, 40, 0.15);
            }
            .btn-gh:active {
                transform: scale(0.96);
                background: #ebedef;
            }

            .shimmer {
                background: linear-gradient(
                    90deg,
                    #f6f8fa 25%,
                    #eff2f5 50%,
                    #f6f8fa 75%
                );
                background-size: 200% 100%;
                animation: shimmer 1.5s infinite;
            }
            @keyframes shimmer {
                0% {
                    background-position: 200% 0;
                }
                100% {
                    background-position: -200% 0;
                }
            }
        </style>
    </head>
    <body class="h-full">
        <header class="glass-header sticky top-0 z-50">
            <div
                class="max-w-6xl mx-auto px-4 md:px-6 flex items-center justify-between h-16"
            >
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 bg-[#1f2328] rounded-lg flex items-center justify-center shadow-sm"
                    >
                        <i class="fi fi-rr-cloud-share text-white text-sm"></i>
                    </div>
                    <span class="font-bold text-lg tracking-tight"
                        >Whatsaly</span
                    >
                </div>

                <nav class="hidden md:flex gap-4">
                    <button
                        onclick="tab('dashboard', this)"
                        class="nav-link active"
                    >
                        <i class="fi fi-rr-apps"></i> Dashboard
                    </button>
                    <button onclick="tab('news', this)" class="nav-link">
                        <i class="fi fi-rr-bell"></i> Updates
                    </button>
                    <button onclick="tab('pair', this)" class="nav-link">
                        <i class="fi fi-rr-add"></i> Link
                    </button>
                </nav>

                <div class="hidden sm:flex items-center">
                    <span
                        class="flex items-center gap-2 text-[10px] font-bold text-[#656d76] bg-[#f6f8fa] px-3 py-1.5 rounded-full border border-[#d0d7de]"
                    >
                        <span
                            class="status-pulse pulse-green animate-pulse"
                        ></span>
                        SYSTEM ACTIVE
                    </span>
                </div>
            </div>
        </header>

        <nav
            class="md:hidden mobile-bottom-nav flex items-center justify-around"
        >
            <button
                onclick="tab('dashboard', this)"
                class="nav-link active flex items-center"
            >
                <i class="fi fi-rr-apps"></i>
                <span>Overview</span>
            </button>
            <button
                onclick="tab('news', this)"
                class="nav-link flex items-center"
            >
                <i class="fi fi-rr-bell"></i>
                <span>Updates</span>
            </button>
            <button
                onclick="tab('pair', this)"
                class="nav-link flex items-center"
            >
                <i class="fi fi-rr-add"></i>
                <span>Connect</span>
            </button>
        </nav>

        <main class="max-w-6xl mx-auto p-4 md:p-8">
            <section
                id="dashboard"
                class="content-section active space-y-4 md:space-y-6"
            >
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 md:gap-4">
                    <div
                        class="gh-card p-4 flex sm:block items-center justify-between"
                    >
                        <div>
                            <span
                                class="text-[10px] font-bold text-[#656d76] uppercase tracking-wider block mb-1"
                                >Processor</span
                            >
                            <div
                                id="cpu-loader"
                                class="shimmer h-6 w-16 rounded"
                            ></div>
                            <div
                                id="cpu-v"
                                class="hidden mono text-xl md:text-2xl font-bold tracking-tighter text-[#1f2328]"
                            >
                                0.0%
                            </div>
                        </div>
                        <i
                            class="fi fi-rr-microchip text-[#d0d7de] text-xl sm:hidden"
                        ></i>
                    </div>
                    <div
                        class="gh-card p-4 flex sm:block items-center justify-between"
                    >
                        <div>
                            <span
                                class="text-[10px] font-bold text-[#656d76] uppercase tracking-wider block mb-1"
                                >Memory</span
                            >
                            <div
                                id="mem-loader"
                                class="shimmer h-6 w-16 rounded"
                            ></div>
                            <div
                                id="mem-v"
                                class="hidden mono text-xl md:text-2xl font-bold tracking-tighter text-[#1f2328]"
                            >
                                0%
                            </div>
                        </div>
                        <i
                            class="fi fi-rr-database text-[#d0d7de] text-xl sm:hidden"
                        ></i>
                    </div>
                    <div
                        class="gh-card p-4 flex sm:block items-center justify-between"
                    >
                        <div>
                            <span
                                class="text-[10px] font-bold text-[#656d76] uppercase tracking-wider block mb-1"
                                >Disk</span
                            >
                            <div
                                id="dsk-loader"
                                class="shimmer h-6 w-16 rounded"
                            ></div>
                            <div
                                id="dsk-v"
                                class="hidden mono text-xl md:text-2xl font-bold tracking-tighter text-[#1f2328]"
                            >
                                0.0%
                            </div>
                        </div>
                        <i
                            class="fi fi-rr-folder-open text-[#d0d7de] text-xl sm:hidden"
                        ></i>
                    </div>
                </div>

                <div class="gh-card shadow-sm">
                    <div class="gh-header flex items-center gap-2">
                        <i class="fi fi-rr-stats text-[#656d76] text-sm"></i>
                        <span class="text-sm font-semibold tracking-tight"
                            >Performance Flow</span
                        >
                    </div>
                    <div class="p-2 md:p-4 h-48 md:h-64">
                        <canvas id="perfChart"></canvas>
                    </div>
                </div>

                <div class="gh-card shadow-sm">
                    <div class="gh-header flex justify-between items-center">
                        <span class="text-sm font-semibold tracking-tight"
                            >Live Instances</span
                        >
                        <span
                            class="text-[9px] font-bold text-[#1f883d] bg-green-50 px-2.5 py-1 rounded-md border border-green-100 tracking-tighter uppercase animate-pulse"
                            >Syncing</span
                        >
                    </div>
                    <div id="session-list" class="divide-y divide-[#d0d7de]">
                        <div
                            class="p-8 text-center text-slate-400 text-sm italic"
                        >
                            Synchronizing...
                        </div>
                    </div>
                </div>
            </section>

            <section id="news" class="content-section">
                <div class="gh-card max-w-2xl mx-auto shadow-sm">
                    <div class="gh-header flex items-center gap-2">
                        <i class="fi fi-rr-bell text-[#656d76] text-sm"></i>
                        <span class="text-sm font-semibold tracking-tight"
                            >WA Beta Updates</span
                        >
                    </div>
                    <div id="news-feed" class="divide-y divide-[#d0d7de]"></div>
                </div>
            </section>

            <section id="pair" class="content-section">
                <div
                    class="gh-card bg-[#f6f8fa] p-8 md:p-16 text-center max-w-md mx-auto border-dashed border-2"
                >
                    <div
                        class="w-16 h-16 bg-white border border-[#d0d7de] rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-sm"
                    >
                        <i
                            class="fi fi-rr-smartphone text-2xl text-[#0969da]"
                        ></i>
                    </div>
                    <h3 class="text-lg md:text-xl font-bold mb-2">
                        Connect Device
                    </h3>
                    <p
                        class="text-xs md:text-sm text-[#656d76] mb-8 leading-relaxed px-4"
                    >
                        Generate a 8-digit code to link your phone number to the
                        control panel.
                    </p>
                    <button
                        onclick="toggleModal(true)"
                        class="w-full btn-gh btn-primary py-4 font-bold text-sm shadow-md shadow-green-100"
                    >
                        Start Connection
                    </button>
                </div>
            </section>
        </main>

        <div
            id="modalOverlay"
            class="fixed inset-0 z-[110] hidden bg-[#1f2328]/60 flex items-center justify-center p-4 backdrop-blur-md"
        >
            <div
                class="bg-white w-full max-w-sm rounded-2xl border border-[#d0d7de] shadow-2xl scale-95 transition-transform"
                id="modalCard"
            >
                <div
                    class="gh-header flex justify-between items-center rounded-t-2xl"
                >
                    <span class="text-sm font-semibold tracking-tight"
                        >Pairing Session</span
                    >
                    <button
                        onclick="toggleModal(false)"
                        class="text-[#656d76] p-2 text-2xl"
                    >
                        &times;
                    </button>
                </div>

                <div id="setupView" class="p-6 space-y-4">
                    <div class="space-y-1.5">
                        <label
                            class="text-[10px] font-bold text-[#656d76] uppercase tracking-widest"
                            >Region</label
                        >
                        <select
                            id="country"
                            class="w-full bg-[#f6f8fa] border border-[#d0d7de] rounded-xl px-4 py-3.5 text-sm outline-none appearance-none"
                        >
                            <option value="234">Nigeria (+234)</option>
                            <option value="1">USA (+1)</option>
                        </select>
                    </div>
                    <div class="space-y-1.5">
                        <label
                            class="text-[10px] font-bold text-[#656d76] uppercase tracking-widest"
                            >Phone</label
                        >
                        <input
                            type="text"
                            id="phone_field"
                            placeholder="81..."
                            class="w-full border border-[#d0d7de] rounded-xl px-4 py-3.5 text-sm outline-none focus:ring-2 focus:ring-blue-100 transition-all"
                        />
                    </div>
                    <button
                        onclick="doPair()"
                        class="w-full btn-gh btn-primary py-4 mt-2"
                    >
                        Generate Link Code
                    </button>
                </div>

                <div id="waitView" class="hidden p-16 text-center space-y-4">
                    <div
                        class="w-10 h-10 border-4 border-[#0969da] border-t-transparent rounded-full animate-spin mx-auto"
                    ></div>
                    <p class="text-xs font-semibold text-[#656d76]">
                        Requesting Credentials...
                    </p>
                </div>

                <div id="resultView" class="hidden p-8 text-center">
                    <span
                        class="text-[10px] font-bold text-[#656d76] tracking-widest block mb-4 uppercase"
                        >Verification Code</span
                    >
                    <div class="flex flex-col gap-4 mb-8">
                        <div
                            id="codeBox"
                            class="mono text-4xl font-black text-[#0969da] bg-[#f0f6ff] px-6 py-6 border border-[#d0d7de] rounded-2xl tracking-[0.3em]"
                        >
                            ------
                        </div>
                        <button
                            onclick="copyCode()"
                            class="btn-gh py-4 w-full bg-white"
                        >
                            <i class="fi fi-rr-copy mr-2"></i> Copy Code
                        </button>
                    </div>
                    <button
                        onclick="toggleModal(false)"
                        class="text-xs font-semibold text-[#656d76] hover:text-[#0969da] transition-colors"
                    >
                        Dismiss Window
                    </button>
                </div>
            </div>
        </div>

        <script>
            let chart;
            let lastSessionData = "";
            const maxPoints = 30;

            function tab(name, el) {
                document
                    .querySelectorAll(".content-section")
                    .forEach((s) => s.classList.remove("active"));
                document
                    .querySelectorAll(".nav-link")
                    .forEach((l) => l.classList.remove("active"));
                document.getElementById(name).classList.add("active");
                el.classList.add("active");
                if (name === "news") fetchNews();
                window.scrollTo({ top: 0, behavior: "smooth" });
            }

            function initChart() {
                const ctx = document
                    .getElementById("perfChart")
                    .getContext("2d");
                chart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: Array(maxPoints).fill(""),
                        datasets: [
                            {
                                data: Array(maxPoints).fill(0),
                                borderColor: "#0969da",
                                borderWidth: 2,
                                backgroundColor: "rgba(9, 105, 218, 0.04)",
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                grid: { color: "#f3f4f6" },
                                ticks: { display: false },
                            },
                            x: { display: false },
                        },
                    },
                });
            }

            function startMonitor() {
                const stream = new EventSource("/api/system/stream");
                stream.onmessage = (e) => {
                    const d = JSON.parse(e.data);
                    ["cpu", "mem", "dsk"].forEach((id) => {
                        document
                            .getElementById(`${id}-loader`)
                            ?.classList.add("hidden");
                        document
                            .getElementById(`${id}-v`)
                            ?.classList.remove("hidden");
                    });
                    document.getElementById("cpu-v").innerText =
                        d.cpu.toFixed(1) + "%";
                    document.getElementById("mem-v").innerText =
                        d.memory.toFixed(1) + "%";
                    document.getElementById("dsk-v").innerText =
                        (d.disk || 0).toFixed(1) + "%";
                    if (chart) {
                        chart.data.datasets[0].data.push(d.cpu);
                        chart.data.datasets[0].data.shift();
                        chart.update("none");
                    }
                };
            }

            function renderSessions(data) {
                const container = document.getElementById("session-list");
                if (!data.length) {
                    container.innerHTML = `<div class="p-12 text-center text-[#656d76] text-sm">No active sessions.</div>`;
                    return;
                }
                container.innerHTML = data
                    .map(
                        (s) => `
                <div class="p-4 flex flex-wrap sm:flex-nowrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 border border-[#d0d7de] rounded-xl bg-white flex items-center justify-center shadow-sm">
                            <i class="fi fi-rr-smartphone text-[#656d76] text-lg"></i>
                        </div>
                        <div>
                            <div class="font-bold text-sm tracking-tight text-[#1f2328]">${s.name}</div>
                            <div class="flex items-center gap-1.5 mt-1">
                                <span class="status-pulse ${s.status === "connected" ? "pulse-green" : "pulse-red"}"></span>
                                <span class="text-[9px] font-bold text-[#656d76] uppercase tracking-widest">${s.status}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="sessionAction('${s.id}', '${s.status === "paused" ? "resume" : "pause"}')" class="btn-gh flex-1 sm:flex-none py-3">
        <i class="fi fi-rr-${s.status === "paused" ? "play" : "pause"}"></i>
    </button>
                        <button onclick="sessionAction('${s.id}', 'reset')" class="btn-gh text-[#cf222e] flex-1 sm:flex-none py-3">
        <i class="fi fi-rr-trash"></i>
    </button>
                    </div>
                </div>
            `,
                    )
                    .join("");
            }

            async function sessionAction(phone, action) {
                try {
                    await fetch(`/api/instances/${phone}/${action}`, {
                        method: "POST",
                    });
                } catch (e) {}
            }

            async function fetchNews() {
                const container = document.getElementById("news-feed");
                container.innerHTML = `<div class="p-8 text-center shimmer h-20 w-full"></div>`;
                try {
                    const res = await fetch("/util/whatsapp-news");
                    const json = await res.json();
                    container.innerHTML = json.data
                        .map(
                            (n) => `
                    <div class="p-5 hover:bg-[#f6f8fa] transition-colors">
                        <a href="${n.link}" target="_blank" class="text-sm font-bold text-[#0969da] block mb-1 underline-offset-4 decoration-[#0969da]/20 hover:decoration-[#0969da] transition-all">${n.title}</a>
                        <p class="text-xs text-[#656d76] leading-relaxed line-clamp-2">${n.description.trim()}</p>
                    </div>
                `,
                        )
                        .join("");
                } catch (e) {
                    container.innerHTML = `<div class="p-8 text-center text-xs text-[#656d76]">Data stream unavailable.</div>`;
                }
            }

            function toggleModal(s) {
                const m = document.getElementById("modalOverlay");
                m.classList.toggle("hidden", !s);
                if (!s) {
                    document.getElementById("setupView").style.display =
                        "block";
                    document.getElementById("waitView").classList.add("hidden");
                    document
                        .getElementById("resultView")
                        .classList.add("hidden");
                }
            }

            async function doPair() {
                let phone = document
                    .getElementById("phone_field")
                    .value.trim()
                    .replace(/^0/, "");
                if (!phone) return;
                const full = document.getElementById("country").value + phone;
                document.getElementById("setupView").style.display = "none";
                document.getElementById("waitView").classList.remove("hidden");
                try {
                    await fetch(`/api/instances/${full}/pair`, {
                        method: "POST",
                    });
                    let att = 0;
                    const poll = setInterval(async () => {
                        att++;
                        const check = await fetch(`/api/instances/${full}`);
                        const d = await check.json();
                        if (d.pairing_code) {
                            clearInterval(poll);
                            document
                                .getElementById("waitView")
                                .classList.add("hidden");
                            document
                                .getElementById("resultView")
                                .classList.remove("hidden");
                            document.getElementById("codeBox").innerText =
                                d.pairing_code;
                        }
                        if (att >= 20) {
                            clearInterval(poll);
                            toggleModal(false);
                        }
                    }, 2000);
                } catch (e) {
                    toggleModal(false);
                }
            }

            function copyCode() {
                navigator.clipboard.writeText(
                    document.getElementById("codeBox").innerText,
                );
                alert("Code copied!");
            }

            function startInstanceStream() {
                const instanceStream = new EventSource("/api/instances/stream");

                instanceStream.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        const currentDataStr = JSON.stringify(data);

                        // Only re-render if the state actually changed to save DOM cycles
                        if (currentDataStr !== lastSessionData) {
                            lastSessionData = currentDataStr;
                            renderSessions(data);
                        }
                    } catch (error) {
                        console.error("Stream Parsing Error:", error);
                    }
                };

                instanceStream.onerror = () => {
                    console.error(
                        "Instance stream lost. Attempting reconnect...",
                    );
                };
            }

            window.onload = () => {
                initChart();
                startMonitor();
                startInstanceStream();
            };
        </script>
    </body>
</html>
